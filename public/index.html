<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Library Books</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
</head>

<body id="page">
    <div class="container is-fluid" id="content">

        <section class="section">
            <div class="container has-text-centered">
                <div class="columns is-centered">
                    <div class="column is-8">
                        <h1 class="title is-1">Library Loans</h1>
                        <p class="subtitle is-3 status">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row cards"></div>
                <div class="results"></div>
            </div>
        </section>
    </div>


    <script>
        let access = ''
        let countDown = 10
        let allData = []
        const fetchData = async (id, pass, renew) => {
            const res = await fetch(`/.netlify/functions/get-loans?id=${id}&pass=${pass}&access=${access}${renew?'&renew':''}`)
            const data = await res.json()
            return data
        }
        const renew = async (name) => {
            const acc = allData.find(d => d.name === name)
            
            console.log('renew', name, acc)
            startCountDown()
            document.querySelector('.cards').innerHTML = ''
            document.querySelector('.results').innerHTML = ''
            await fetchData(acc.id, acc.password, true)
            countDown = 0
            console.log('allData', allData)
            renderData(allData)
        }
        const renderData = (allData) => {
            const headerHtml = allData.map(acc => {
                return `
                    <div class="col">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${acc.name}</h5>
                                <p class="card-text">Current Loans: <span class="badge text-bg-secondary">${acc.loanCount}</span></p>
                                <p class="card-text">Fines: <span class="badge text-bg-secondary">Â£${acc.fines}</span></p>
                                ${acc.loanCount>0?`<button class="btn btn-warning btn-sm" onclick="renew(\'${acc.name}\')">Renew all</button>`:''}
                            </div>
                        </div>
                    </div>
                `
            }).join('')
            document.querySelector('.cards').innerHTML = headerHtml
            document.querySelector('.results').innerHTML = `
            <div class="col table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Book</th>
                            <th>Due Date</th>
                            <th>Account</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${allData.map(acc => {
                        return acc.loans.map(loan => {
                            return `
                            <tr>
                                <td><img src="${loan.img}" style="max-width:100px;"/></td>
                                <td>${loan.name}</td>
                                <td>${loan.due}</td>
                                <td>${acc.name}</td>
                            </tr>
                            `
                            }).join('')
                        }).join('')
                    }
                    </tbody>
                </table>
            </div>`
        }
        const startCountDown = () => {
            countDown = 10
            const countDownInterval = setInterval(() => {
                document.querySelector('.status').innerHTML = `Loading: ${countDown}`
                countDown--
                if (countDown < 0) {
                    document.querySelector('.status').innerHTML = 'Ready!'
                    clearInterval(countDownInterval)
                }
            }, 1000)
        }
        const init = async () => {
            try {
                const urlParams = new URLSearchParams(window.location.search)
                access = urlParams.get('access')
                const accounts = urlParams.get('accounts').split('|').map(a => a.split('-'))

                console.log('access', access)
                console.log('accounts', accounts)


                startCountDown()
                allData = await Promise.all(accounts.map(creds => fetchData(creds[0],creds[1])))
                countDown = 0
                console.log('allData', allData)
                renderData(allData)
                

            } catch (error) {
                alert('Error')
            }
            
        }
        init()
    </script>
</body>

</html>